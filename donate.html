<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Kick Video Donation - Donate</title>
<style>
/* 기본 스타일 생략, 기존 donate.css 그대로 사용 가능 */
</style>
</head>
<body>
<div class="shell" id="app">
  <div class="card">
    <header>
      <h1>무료 영상 도네이션</h1>
      <span class="badge" id="status-badge">로컬 데모</span>
    </header>
    <div class="content">
      <div class="stack">
        <label>닉네임</label>
        <input id="name" placeholder="닉네임"/>
        <label>영상 URL</label>
        <input id="url" placeholder="YouTube/MP4/Twitch"/>
        <label>메시지 (선택)</label>
        <textarea id="msg" placeholder="하고 싶은 말"></textarea>
        <div class="row">
          <button class="btn" id="send">영상 보내기</button>
        </div>
        <div class="list" id="queue-list"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const ROOM = "tobrothertoiden"; // Kick 닉네임 기반 룸
const firebaseConfig = {
  apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
  authDomain: "toiden.firebaseapp.com",
  databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toiden",
  storageBucket: "toiden.firebasestorage.app",
  messagingSenderId: "696461176231",
  appId: "1:696461176231:web:2120f172e52eaba91a1a82"
};
firebase.initializeApp(firebaseConfig);

function classifyURL(url){
  try{
    const u = new URL(url);
    const host = u.host.replace('www.','');
    if(/youtube\.com|youtu\.be/.test(host)) return {type:'youtube', id:extractYouTubeId(u)};
    if(/clips\.twitch\.tv/.test(host) || /twitch\.tv/.test(host)) return {type:'twitch', url};
    if(/\.(mp4|webm|ogg)$/i.test(u.pathname)) return {type:'html5', url};
    return {type:'unknown'};
  }catch(e){ return {type:'invalid'}; }
}
function extractYouTubeId(u){
  if(u.hostname==='youtu.be') return u.pathname.slice(1);
  return new URLSearchParams(u.search).get('v');
}

document.getElementById('send').addEventListener('click', ()=>{
  const name = document.getElementById('name').value || '익명';
  const url = document.getElementById('url').value.trim();
  const msg = document.getElementById('msg').value.slice(0,140);
  const c = classifyURL(url);
  if(c.type==='invalid' || c.type==='unknown') return alert('지원하지 않는 URL입니다.');
  const newRef = firebase.database().ref(`rooms/${ROOM}/queue`).push();
  newRef.set({
    name, url, type:c.type, ytid:c.id||null, msg, ts:Date.now(), id:newRef.key
  });
  document.getElementById('url').value='';
  document.getElementById('msg').value='';
});

// 큐 미리보기
firebase.database().ref(`rooms/${ROOM}/queue`).on('value', snap=>{
  const list = snap.val()||{};
  const $list = document.getElementById('queue-list');
  $list.innerHTML='';
  Object.values(list).forEach(item=>{
    const el = document.createElement('div');
    el.className='q-item';
    el.innerHTML=`${item.name} (${item.type}): ${item.url} ${item.msg? '<div>'+item.msg+'</div>':''}`;
    $list.appendChild(el);
  });
});
</script>
</body>
</html>
