<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>영상 후원</title>
<style>
  body{margin:0;font-family:'Segoe UI',sans-serif;background:#f0f4f8;color:#333;}
  header{background:#2563eb;color:white;padding:16px;text-align:center;font-size:1.5rem;}
  main{max-width:600px;margin:30px auto;padding:20px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  label{display:block;margin:12px 0 4px;font-weight:600;}
  input,textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:1rem;}
  button{margin-top:16px;width:100%;padding:12px;background:#2563eb;color:white;font-weight:600;border:none;border-radius:8px;cursor:pointer;}
  button:hover{background:#1e40af;}
  .info{margin-top:12px;font-size:0.9rem;color:#555;}
  .queue-list{margin-top:20px;}
  .q-item{margin-bottom:10px;padding:10px;border-left:4px solid #2563eb;background:#f9fafb;border-radius:6px;}
  .q-item b{color:#2563eb;}
</style>
</head>
<body>
<header>영상 후원 페이지</header>
<main>
  <form id="donate-form">
    <label for="name">닉네임</label>
    <input type="text" id="name" placeholder="홍길동 / 익명 가능" required>

    <label for="url">영상 URL</label>
    <input type="url" id="url" placeholder="YouTube / Twitch / mp4 URL" required>

    <label for="msg">메시지</label>
    <textarea id="msg" rows="3" placeholder="응원 메시지를 입력하세요"></textarea>

    <button type="submit">전송</button>
  </form>
  
  <div class="info">
    ※ 제출하신 영상은 관리자 검토 후 오버레이에 표시됩니다.
  </div>

  <div class="queue-list" id="queue-list"></div>
</main>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
const ROOM = 'tobrothertoiden';
const firebaseConfig = {
  apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
  authDomain: "toiden.firebaseapp.com",
  databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toiden",
  storageBucket: "toiden.firebasestorage.app",
  messagingSenderId: "696461176231",
  appId: "1:696461176231:web:2120f172e52eaba91a1a82"
};
firebase.initializeApp(firebaseConfig);

const dbRef = firebase.database().ref(`rooms/${ROOM}/queue`);
const form = document.getElementById('donate-form');
const $queue = document.getElementById('queue-list');

function renderQueue(queue){
  $queue.innerHTML='';
  queue.forEach(item=>{
    const div = document.createElement('div');
    div.className='q-item';
    div.innerHTML=`<b>${item.name}</b><br>${item.url}<br>${item.msg||''}`;
    $queue.appendChild(div);
  });
}

dbRef.on('value', snap=>{
  const val = snap.val()||{};
  const queue = Object.values(val);
  renderQueue(queue);
});

form.addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('name').value.trim() || '익명';
  const url = document.getElementById('url').value.trim();
  const msg  = document.getElementById('msg').value.trim();
  if(!url) return alert('URL을 입력하세요.');

  let type='html5', ytid=null;
  if(url.includes('youtube.com') || url.includes('youtu.be')){
    type='youtube';
    const m = url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
    if(m) ytid=m[1];
  } else if(url.includes('twitch.tv')){
    type='twitch';
  }

  const ts = Date.now();
  dbRef.push({name,url,type,ytid,msg,ts})
    .then(()=>form.reset())
    .catch(err=>alert('오류 발생: '+err.message));
});
</script>
</body>
</html>
