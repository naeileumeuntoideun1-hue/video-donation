<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    body { font-family: sans-serif; text-align:center; margin-top:50px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ddd; padding:8px; }
    th { background:#f5f5f5; }
    button { padding:5px 10px; }
  </style>
</head>
<body>
  <h2>Admin Panel</h2>
  <table id="queueTable">
    <thead>
      <tr>
        <th>이름</th>
        <th>URL</th>
        <th>메시지</th>
        <th>송출</th>
        <th>삭제</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, onValue, set, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
  authDomain: "toiden.firebaseapp.com",
  databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toiden",
  storageBucket: "toiden.firebasestorage.app",
  messagingSenderId: "696461176231",
  appId: "1:696461176231:web:2120f172e52eaba91a1a82"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const room = "tobrothertoiden";
const tbody = document.querySelector("#queueTable tbody");

// 관리자 페이지 초기화
function initAdmin(){
  const queueRef = ref(db, `rooms/${room}/queue`);
  
  // 큐 실시간 반영
  onValue(queueRef, snapshot=>{
    const data = snapshot.val() || {};
    tbody.innerHTML = "";
    Object.entries(data).forEach(([key, video])=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${video.name ?? ""}</td>
        <td><a href="${video.url}" target="_blank" rel="noopener">${video.url}</a></td>
        <td>${video.msg ?? ""}</td>
        <td><button data-key="${key}" class="playBtn">송출</button></td>
        <td><button data-key="${key}" class="delBtn">삭제</button></td>
      `;
      tbody.appendChild(tr);
    });
  });

  // 버튼 이벤트
  tbody.addEventListener("click", e=>{
    const btn = e.target.closest("button"); 
    if(!btn) return;
    const key = btn.dataset.key; 
    if(!key) return;

    if(btn.classList.contains("playBtn")){
      get(ref(db, `rooms/${room}/queue/${key}`)).then(snap=>{
        const video = snap.val();
        if(video) set(ref(db, `rooms/${room}/currentVideo`), video);
      });
    }

    if(btn.classList.contains("delBtn")){
      get(ref(db, `rooms/${room}/queue/${key}`)).then(snap=>{
        const video = snap.val();
        if(video){
          remove(ref(db, `rooms/${room}/queue/${key}`));
          get(ref(db, `rooms/${room}/currentVideo`)).then(snapCur=>{
            const current = snapCur.val();
            if(current && current.url === video.url){
              remove(ref(db, `rooms/${room}/currentVideo`));
            }
          });
        }
      });
    }
  });
}

// 바로 관리자 페이지 초기화
initAdmin();
</script>
</body>
</html>
