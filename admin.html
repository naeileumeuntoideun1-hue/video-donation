<body>
  <div id="loginContainer" style="text-align:center;margin-top:100px;">
    <h2>관리자 로그인</h2>
    <input type="password" id="adminPass" placeholder="비밀번호 입력" style="padding:8px;font-size:16px;">
    <button id="loginBtn" style="padding:8px 16px;font-size:16px;">로그인</button>
    <p id="loginMsg" style="color:red;"></p>
  </div>

  <div id="adminContainer" style="display:none;">
    <table id="queueTable" border="1" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th>이름</th>
          <th>URL</th>
          <th>메시지</th>
          <th>송출</th>
          <th>삭제</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, onValue, set, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
      authDomain: "toiden.firebaseapp.com",
      databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "toiden",
      storageBucket: "toiden.firebasestorage.app",
      messagingSenderId: "696461176231",
      appId: "1:696461176231:web:2120f172e52eaba91a1a82"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const room = "tobrothertoiden";
    const tbody = document.querySelector("#queueTable tbody");

    const loginBtn = document.getElementById("loginBtn");
    const passInput = document.getElementById("adminPass");
    const loginMsg = document.getElementById("loginMsg");
    const loginContainer = document.getElementById("loginContainer");
    const adminContainer = document.getElementById("adminContainer");

    let userIP = "unknown";

    async function getUserIP() {
      try {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 4000);
        const res = await fetch("https://api.ipify.org?format=json", { signal: ctrl.signal });
        clearTimeout(t);
        if (!res.ok) throw new Error("ipify failed");
        const data = await res.json();
        return data.ip || "unknown";
      } catch (e) {
        // ipify 실패 시 로컬 대체
        return "unknown";
      }
    }

    // 로컬스토리지 기반 보조 차단 (IP 못가져올 때)
    const localLockKey = "adminLoginLock";
    function setLocalLock(minutes = 10) {
      const until = Date.now() + minutes * 60 * 1000;
      localStorage.setItem(localLockKey, String(until));
    }
    function isLocalLocked() {
      const until = Number(localStorage.getItem(localLockKey) || 0);
      return until && Date.now() < until;
    }

    async function loginAdmin() {
      loginMsg.textContent = "";

      // 로컬 락 확인
      if (isLocalLocked()) {
        loginMsg.textContent = "잠시 후 다시 시도하세요. (로컬 차단 중)";
        return;
      }

      // IP 확인
      if (userIP === "unknown") {
        userIP = await getUserIP();
      }

      // 실패 카운트 조회
      const failRef = ref(db, `rooms/${room}/loginFail/${encodeURIComponent(userIP)}`);
      const failSnap = await get(failRef);
      const failData = failSnap.exists() ? failSnap.val() : { count: 0, blockedUntil: 0 };

      const now = Date.now();
      if (failData.blockedUntil && now < failData.blockedUntil) {
        loginMsg.textContent = "10분 후 다시 시도하세요.";
        return;
      }

      // 서버 비밀번호 조회
      const passRef = ref(db, `rooms/${room}/adminPass`);
      const snap = await get(passRef);
      const correctPass = snap.exists() ? String(snap.val()) : null;

      if (!correctPass) {
        loginMsg.textContent = "서버에 비밀번호가 설정되어 있지 않습니다.";
        return;
      }

      const inputPass = passInput.value;
      if (inputPass === correctPass) {
        // 성공 → 실패 기록 초기화
        await set(failRef, { count: 0, blockedUntil: 0 });
        loginContainer.style.display = "none";
        adminContainer.style.display = "block";
        initAdmin();
      } else {
        // 실패 처리
        let newCount = (failData.count || 0) + 1;
        let blockedUntil = failData.blockedUntil || 0;
        if (newCount >= 5) {
          blockedUntil = now + 10 * 60 * 1000; // 10분 차단
          newCount = 0; // 카운트 리셋
          setLocalLock(10); // 로컬도 같이 차단
          alert("5회 실패로 10분간 차단됩니다.");
        }
        await set(failRef, { count: newCount, blockedUntil });
        loginMsg.textContent = "비밀번호가 틀렸습니다.";
      }
    }

    loginBtn.addEventListener("click", loginAdmin);
    passInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loginAdmin();
    });

    // 관리자 페이지 초기화
    function initAdmin() {
      const queueRef = ref(db, `rooms/${room}/queue`);
      onValue(queueRef, (snapshot) => {
        const data = snapshot.val() || {};
        tbody.innerHTML = "";
        Object.entries(data).forEach(([key, video]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${video.name ?? ""}</td>
            <td><a href="${video.url}" target="_blank" rel="noopener">${video.url}</a></td>
            <td>${video.msg ?? ""}</td>
            <td><button data-key="${key}" class="playBtn">송출</button></td>
            <td><button data-key="${key}" class="delBtn">삭제</button></td>
          `;
          tbody.appendChild(tr);
        });
      });

      tbody.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const key = btn.dataset.key;
        if (!key) return;

        if (btn.classList.contains("playBtn")) {
          get(ref(db, `rooms/${room}/queue/${key}`)).then((snapshot) => {
            const video = snapshot.val();
            if (video) {
              set(ref(db, `rooms/${room}/currentVideo`), video);
            }
          });
        }

        if (btn.classList.contains("delBtn")) {
          get(ref(db, `rooms/${room}/queue/${key}`)).then((snapshot) => {
            const video = snapshot.val();
            if (video) {
              remove(ref(db, `rooms/${room}/queue/${key}`));
              get(ref(db, `rooms/${room}/currentVideo`)).then((snapCur) => {
                const current = snapCur.val();
                if (current && current.url === video.url) {
                  remove(ref(db, `rooms/${room}/currentVideo`));
                }
              });
            }
          });
        }
      });
    }
  </script>
</body>
