<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  button { margin: 5px; padding: 5px 10px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
</style>
</head>
<body>
<h1>Admin Panel</h1>
<table id="queueTable">
  <thead>
    <tr>
      <th>이름</th>
      <th>영상 링크</th>
      <th>메세지</th>
      <th>송출</th>
      <th>삭제</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
  authDomain: "toiden.firebaseapp.com",
  databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toiden",
  storageBucket: "toiden.firebasedestorage.app",
  messagingSenderId: "696461176231",
  appId: "1:696461176231:web:2120f172e52eaba91a1a82"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const room = "tobrothertoiden";

const tbody = document.querySelector("#queueTable tbody");

// 큐 감시
const queueRef = ref(db, `rooms/${room}/queue`);
onValue(queueRef, snapshot => {
  const data = snapshot.val();
  tbody.innerHTML = "";
  if(!data) return;
  Object.entries(data).forEach(([key, video])=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${video.name}</td>
      <td><a href="${video.url}" target="_blank">${video.url}</a></td>
      <td>${video.msg}</td>
      <td><button data-key="${key}" class="playBtn">송출</button></td>
      <td><button data-key="${key}" class="delBtn">삭제</button></td>
    `;
    tbody.appendChild(tr);
  });
});

// 송출 버튼
tbody.addEventListener("click", e=>{
  if(e.target.classList.contains("playBtn")){
    const key = e.target.dataset.key;
    const videoRef = ref(db, `rooms/${room}/queue/${key}`);
    onValue(videoRef, snapshot=>{
      const video = snapshot.val();
      if(video){
        set(ref(db, `rooms/${room}/currentVideo`), video);
      }
    }, {once:true});
  }
});

// 삭제 버튼
tbody.addEventListener("click", e=>{
  if(e.target.classList.contains("delBtn")){
    const key = e.target.dataset.key;
    remove(ref(db, `rooms/${room}/queue/${key}`));
    // 현재 재생중이면 오버레이에서도 제거
    onValue(ref(db, `rooms/${room}/currentVideo`), snapshot=>{
      const current = snapshot.val();
      if(current && current.url === key){
        remove(ref(db, `rooms/${room}/currentVideo`));
      }
    }, {once:true});
  }
});
</script>
</body>
</html>
