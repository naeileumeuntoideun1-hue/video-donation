<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, onValue, set, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
  authDomain: "toiden.firebaseapp.com",
  databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toiden",
  storageBucket: "toiden.firebasestorage.app",
  messagingSenderId: "696461176231",
  appId: "1:696461176231:web:2120f172e52eaba91a1a82"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const room = "tobrothertoiden";
const tbody = document.querySelector("#queueTable tbody");

// 비밀번호 확인 로직
async function checkPassword() {
  const passRef = ref(db, `rooms/${room}/adminPass`);
  const snap = await get(passRef);
  const correctPass = snap.exists() ? snap.val() : null;
  
  if (!correctPass) {
    alert("서버에 비밀번호가 설정되어 있지 않습니다.");
    return false;
  }

  const input = prompt("관리자 비밀번호를 입력하세요:");
  if (input === correctPass) {
    return true;
  } else {
    alert("잘못된 비밀번호입니다.");
    return false;
  }
}

// 관리자 페이지 초기화
async function initAdmin() {
  const allowed = await checkPassword();
  if (!allowed) {
    document.body.innerHTML = "<h2 style='text-align:center;color:red;'>접근 거부</h2>";
    return;
  }

  // 큐 감시 및 테이블 갱신
  const queueRef = ref(db, `rooms/${room}/queue`);
  onValue(queueRef, snapshot => {
    const data = snapshot.val() || {};
    tbody.innerHTML = "";
    Object.entries(data).forEach(([key, video]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${video.name}</td>
        <td><a href="${video.url}" target="_blank">${video.url}</a></td>
        <td>${video.msg}</td>
        <td><button data-key="${key}" class="playBtn">송출</button></td>
        <td><button data-key="${key}" class="delBtn">삭제</button></td>
      `;
      tbody.appendChild(tr);
    });
  });

  // 송출 버튼
  tbody.addEventListener("click", e => {
    if (e.target.classList.contains("playBtn")) {
      const key = e.target.dataset.key;
      get(ref(db, `rooms/${room}/queue/${key}`)).then(snapshot => {
        const video = snapshot.val();
        if (video) {
          set(ref(db, `rooms/${room}/currentVideo`), video);
        }
      });
    }
  });

  // 삭제 버튼
  tbody.addEventListener("click", e => {
    if (e.target.classList.contains("delBtn")) {
      const key = e.target.dataset.key;
      get(ref(db, `rooms/${room}/queue/${key}`)).then(snapshot => {
        const video = snapshot.val();
        if (video) {
          remove(ref(db, `rooms/${room}/queue/${key}`));
          get(ref(db, `rooms/${room}/currentVideo`)).then(snapCur => {
            const current = snapCur.val();
            if (current && current.url === video.url) {
              remove(ref(db, `rooms/${room}/currentVideo`));
            }
          });
        }
      });
    }
  });
}

initAdmin();
</script>
