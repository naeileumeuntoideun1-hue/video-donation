
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>영상 도네 관리자</title>
<link rel="stylesheet" href="common.css">
</head>
<body>
<h1>🎬 영상 도네 관리자</h1>
<div class="admin-box">
  <label for="filter">닉네임/메시지 검색</label>
  <input type="text" id="filter" placeholder="검색어 입력">
  
  <div id="queue-list"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
<script src="common.js"></script>
<script>
const room = new URLSearchParams(window.location.search).get('room') || 'default';
const filterInput = document.getElementById('filter');
const queueList = document.getElementById('queue-list');

function renderQueue(list){
    queueList.innerHTML = '';
    list.forEach((item, idx)=>{
        const div = document.createElement('div');
        div.className = 'q-item';
        div.innerHTML = `
          <div>
            <b>${item.user||'익명'}</b> <small>${new Date(item.timestamp).toLocaleTimeString()}</small><br>
            <a href="${item.url}" target="_blank">${item.url}</a>
            ${item.message ? '<div class="note">'+item.message+'</div>' : ''}
          </div>
          <div class="actions">
            <button onclick="approve(${idx})" class="btn secondary">승인</button>
            <button onclick="remove(${idx})" class="btn danger">삭제</button>
          </div>
        `;
        queueList.appendChild(div);
    });
}

firebase.database().ref(`rooms/${room}/queue`).on('value', snap=>{
    const data = snap.val() ? Object.values(snap.val()) : [];
    const filterText = filterInput.value.toLowerCase();
    const filtered = data.filter(d => 
        (d.user||'').toLowerCase().includes(filterText) ||
        (d.message||'').toLowerCase().includes(filterText)
    );
    renderQueue(filtered);
});

function remove(idx){
    if(confirm('정말 삭제하시겠습니까?')){
        firebase.database().ref(`rooms/${room}/queue`).once('value').then(snap=>{
            const key = Object.keys(snap.val())[idx];
            firebase.database().ref(`rooms/${room}/queue/${key}`).remove();
        });
    }
}

function approve(idx){
    alert('승인되었습니다. 오버레이에서 재생됩니다.');
}

filterInput.addEventListener('input', ()=>{
    firebase.database().ref(`rooms/${room}/queue`).once('value').then(snap=>{
        const data = snap.val() ? Object.values(snap.val()) : [];
        const filterText = filterInput.value.toLowerCase();
        const filtered = data.filter(d => 
            (d.user||'').toLowerCase().includes(filterText) ||
            (d.message||'').toLowerCase().includes(filterText)
        );
        renderQueue(filtered);
    });
});
</script>
</body>
</html>
