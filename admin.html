<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video Donation 관리자</title>
  <style>
    body { font-family: sans-serif; background:#0b0f14; color:#e6edf3; margin:0; padding:0; }
    .shell { max-width:960px; margin:20px auto; padding:0 10px; }
    h1 { text-align:center; margin-bottom:20px; }
    .list { display:flex; flex-direction:column; gap:10px; }
    .q-item { display:flex; flex-direction:column; padding:12px; border-radius:12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); }
    .q-item .title { font-weight:700; }
    .q-item .actions { margin-top:6px; display:flex; gap:8px; }
    button { padding:6px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn-play { background: linear-gradient(135deg,#22c55e,#16a34a); color:#05120a; }
    .btn-delete { background: linear-gradient(135deg,#ef4444,#dc2626); color:#130607; }
  </style>
</head>
<body>
<div class="shell">
  <h1>Video Donation 관리자</h1>
  <div class="list" id="admin-queue"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
  authDomain: "toiden.firebaseapp.com",
  databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toiden",
  storageBucket: "toiden.firebasestorage.app",
  messagingSenderId: "696461176231",
  appId: "1:696461176231:web:2120f172e52eaba91a1a82"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const ROOM = "tobrothertoiden";
const queueRef = db.ref(`rooms/${ROOM}/queue`);
const $list = document.getElementById("admin-queue");

function escapeHtml(s){ return (s||'').replace(/[&<>"]+/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

function renderQueue(snapshot){
  const data = snapshot.val() || {};
  $list.innerHTML = '';
  Object.entries(data).sort((a,b)=> (a[1].ts||0)-(b[1].ts||0)).forEach(([key,item])=>{
    const el = document.createElement("div");
    el.className="q-item";
    el.innerHTML = `
      <div class="title">${escapeHtml(item.name)} (${item.type})</div>
      <div>${escapeHtml(item.url)}</div>
      ${item.msg? `<div>💬 ${escapeHtml(item.msg)}</div>`: ''}
      <div class="actions">
        <button class="btn-play" data-key="${key}">영상 송출</button>
        <button class="btn-delete" data-key="${key}">삭제</button>
      </div>
    `;
    $list.appendChild(el);
  });
}
queueRef.on("value", renderQueue);

$list.addEventListener("click", async (e)=>{
  const playBtn = e.target.closest(".btn-play");
  const delBtn  = e.target.closest(".btn-delete");
  if(playBtn){
    const key = playBtn.dataset.key;
    const snapshot = await queueRef.child(key).once("value");
    const item = snapshot.val();
    if(item){
      const overlayRef = db.ref(`rooms/${ROOM}/overlay`);
      await overlayRef.set({...item, ts:Date.now()});
      await queueRef.child(key).remove();
    }
  }
  if(delBtn){
    const key = delBtn.dataset.key;
    if(confirm("정말 삭제하시겠습니까?")) await queueRef.child(key).remove();
  }
});
</script>
</body>
</html>
