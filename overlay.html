<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Video Overlay</title>
<style>
  body { margin: 0; background: black; display: flex; justify-content: center; align-items: center; height: 100vh; }
  #player { width: 100%; height: 100%; }
</style>
</head>
<body>
<div id="player"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
  authDomain: "toiden.firebaseapp.com",
  databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toiden",
  storageBucket: "toiden.firebasedestorage.app",
  messagingSenderId: "696461176231",
  appId: "1:696461176231:web:2120f172e52eaba91a1a82"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const room = "tobrothertoiden";

let player;

// YouTube API 로드
function loadYouTubeAPI() {
  return new Promise((resolve) => {
    if(window.YT && window.YT.Player) resolve();
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
    window.onYouTubeIframeAPIReady = resolve;
  });
}

// 영상 재생
function playVideo(ytid){
  if(!ytid) return;
  if(player){
    player.loadVideoById(ytid);
  } else {
    player = new YT.Player('player', {
      videoId: ytid,
      playerVars: { autoplay: 1, controls: 1 },
      events: { 'onReady': e => e.target.playVideo() }
    });
  }
}

// OBS 실시간 감시
const queueRef = ref(db, `rooms/${room}/currentVideo`);
onValue(queueRef, async (snapshot)=>{
  const video = snapshot.val();
  if(!video){
    // 삭제시 플레이어 제거
    if(player) player.destroy();
    player = null;
    return;
  }
  if(video.type === "youtube" && video.ytid){
    await loadYouTubeAPI();
    playVideo(video.ytid);
  }
});
</script>
</body>
</html>
