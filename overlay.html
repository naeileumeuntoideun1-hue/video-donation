<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>오버레이</title>
<style>
  body,html{margin:0;padding:0;background:transparent;overflow:hidden;height:100%;}
  #player{width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
  iframe,video{max-width:100%;max-height:100%;border:none;border-radius:8px;}
</style>
</head>
<body>
<div id="player"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
const ROOM = 'tobrothertoiden';
const firebaseConfig = {
  apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
  authDomain: "toiden.firebaseapp.com",
  databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toiden",
  storageBucket: "toiden.firebasestorage.app",
  messagingSenderId: "696461176231",
  appId: "1:696461176231:web:2120f172e52eaba91a1a82"
};
firebase.initializeApp(firebaseConfig);

const dbRef = firebase.database().ref(`rooms/${ROOM}/queue`);
const $player = document.getElementById('player');

let queue = [];
let currentIndex = 0;

function mountPlayer(item){
  $player.innerHTML='';
  if(!item) return;
  if(item.type==='youtube' && item.ytid){
    const iframe=document.createElement('iframe');
    iframe.src=`https://www.youtube.com/embed/${item.ytid}?autoplay=1&mute=1`;
    iframe.allow='autoplay; encrypted-media';
    iframe.width='100%'; iframe.height='100%';
    $player.appendChild(iframe);
  } else if(item.type==='twitch'){
    const iframe=document.createElement('iframe');
    iframe.src=`https://clips.twitch.tv/embed?clip=${encodeURIComponent(new URL(item.url).pathname.split('/').pop())}&parent=${location.hostname}&autoplay=true&muted=true`;
    iframe.width='100%'; iframe.height='100%';
    $player.appendChild(iframe);
  } else if(item.type==='html5'){
    const v=document.createElement('video');
    v.src=item.url; v.autoplay=true; v.muted=true; v.controls=true; v.playsInline=true;
    v.width='100%'; v.height='100%';
    v.onended=playNext;
    $player.appendChild(v);
  }
}

function playNext(){
  currentIndex++;
  if(currentIndex>=queue.length){currentIndex=0;} // 반복 재생
  mountPlayer(queue[currentIndex]);
}

dbRef.on('value', snap=>{
  const val = snap.val()||{};
  queue = Object.values(val);
  if(queue.length>0) mountPlayer(queue[currentIndex % queue.length]);
  else $player.innerHTML=''; // 큐 비었으면 플레이어 제거
});
</script>
</body>
</html>
