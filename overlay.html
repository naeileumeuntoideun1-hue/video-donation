<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Donation Overlay</title>
<style>
body, html{margin:0;padding:0;width:100%;height:100%;background:transparent;overflow:hidden;}
#overlay{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
#msgOverlay{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-size:72px;font-weight:bold;color:#fff;text-align:center;display:none;text-shadow: 2px 2px 5px #000;}
#player{width:80%;height:45%;background:#000;border-radius:10px;overflow:hidden;}
</style>
</head>
<body>
<div id="overlay">
    <div id="msgOverlay"></div>
    <div id="player"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
  authDomain: "toiden.firebaseapp.com",
  databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toiden",
  storageBucket: "toiden.firebasestorage.app",
  messagingSenderId: "696461176231",
  appId: "1:696461176231:web:2120f172e52eaba91a1a82"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const roomRef = db.ref('rooms/tobrothertoiden/queue');

const msgOverlay = document.getElementById('msgOverlay');
const playerDiv = document.getElementById('player');

function escapeHtml(s){return (s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}

// 새로 들어온 영상 감지
roomRef.on('child_added', snapshot=>{
    const item = snapshot.val();
    // 메시지 먼저 표시
    msgOverlay.textContent = `${item.name} : ${item.msg}`;
    msgOverlay.style.display='block';
    playerDiv.innerHTML='';

    setTimeout(()=>{
        msgOverlay.style.display='none';
        // 영상 재생
        if(item.type==='youtube' && item.ytid){
            const iframe = document.createElement('iframe');
            iframe.width='100%';
            iframe.height='100%';
            iframe.allow='autoplay; encrypted-media';
            iframe.src = `https://www.youtube.com/embed/${item.ytid}?autoplay=1&mute=0`;
            iframe.frameBorder='0';
            playerDiv.appendChild(iframe);
        }else if(item.type==='html5'){
            const v = document.createElement('video');
            v.src=item.url;
            v.autoplay=true;
            v.controls=false;
            v.muted=false;
            v.style.width='100%';
            v.style.height='100%';
            v.playsInline=true;
            playerDiv.appendChild(v);
            v.onended=()=>{ snapshot.ref.remove(); };
        }else if(item.type==='twitch'){
            const clipID = new URL(item.url).pathname.split('/').pop();
            const iframe = document.createElement('iframe');
            iframe.width='100%';
            iframe.height='100%';
            iframe.allow='autoplay';
            iframe.src = `https://clips.twitch.tv/embed?clip=${encodeURIComponent(clipID)}&parent=${location.hostname}&autoplay=true&muted=false`;
            iframe.frameBorder='0';
            playerDiv.appendChild(iframe);
        }else{
            playerDiv.textContent='지원되지 않는 영상입니다.';
            setTimeout(()=>{ snapshot.ref.remove(); },5000);
        }

        // YouTube/Twitch iframe 강제로 30초 후 삭제
        if(item.type==='youtube' || item.type==='twitch'){
            setTimeout(()=>{ snapshot.ref.remove(); }, 30000);
        }

    },5000);
});
</script>
</body>
</html>
