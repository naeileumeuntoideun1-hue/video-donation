<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Video Donation Overlay</title>
<style>
  body, html{margin:0;padding:0;width:100%;height:100%;background:transparent;}
  .overlay{position:relative;width:100%;height:100%;display:flex;justify-content:center;align-items:center;}
  #player{width:100%;height:100%;border:none;background:transparent;}
  .msg-box{position:absolute;bottom:10%;left:50%;transform:translateX(-50%);padding:12px 20px;background:rgba(0,0,0,0.5);color:#fff;font-size:18px;border-radius:12px;display:none;}
  .controls{position:absolute;top:10px;left:50%;transform:translateX(-50%);display:flex;gap:10px;}
  .btn{padding:8px 14px;border:none;border-radius:8px;background:#4ade80;color:#05120a;font-weight:700;cursor:pointer;}
</style>
</head>
<body>
<div class="overlay">
  <div id="player"></div>
  <div class="msg-box" id="msg-box"></div>
  <div class="controls">
    <button class="btn" id="play-next">영상 송출</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
  // Firebase 초기화
  const firebaseConfig = {
    apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
    authDomain: "toiden.firebaseapp.com",
    databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "toiden",
    storageBucket: "toiden.firebasestorage.app",
    messagingSenderId: "696461176231",
    appId: "1:696461176231:web:2120f172e52eaba91a1a82"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const ROOM = new URLSearchParams(location.search).get('room') || 'tobrothertoiden';
  const playerEl = document.getElementById('player');
  const msgBox = document.getElementById('msg-box');
  const playBtn = document.getElementById('play-next');

  let queue = [];
  let currentIndex = -1;
  let readyToPlay = false;

  // Firebase 큐 실시간 구독
  db.ref(`rooms/${ROOM}/queue`).on('value', snap=>{
    const val = snap.val()||{};
    queue = Object.entries(val).map(([k,v])=>({...v, key:k})).sort((a,b)=> (a.ts||0)-(b.ts||0));
    if(!readyToPlay && queue.length>0){
      currentIndex = 0;
      msgBox.style.display = 'block';
      msgBox.textContent = queue[currentIndex].msg || '';
    }
    if(queue.length===0){
      playerEl.innerHTML='';
      msgBox.style.display='none';
      currentIndex=-1;
    }
  });

  function mountPlayer(item){
    playerEl.innerHTML='';
    msgBox.style.display = item.msg ? 'block' : 'none';
    msgBox.textContent = item.msg || '';
    if(item.type==='youtube' && item.ytid){
      const iframe = document.createElement('iframe');
      iframe.width='100%'; iframe.height='100%'; iframe.allow='autoplay; encrypted-media';
      iframe.src = `https://www.youtube.com/embed/${item.ytid}?autoplay=1&mute=0`;
      iframe.frameBorder='0';
      playerEl.appendChild(iframe);
    } else if(item.type==='html5'){
      const v = document.createElement('video');
      v.src=item.url; v.autoplay=true; v.controls=true; v.style.width='100%'; v.style.height='100%';
      playerEl.appendChild(v);
    } else if(item.type==='twitch'){
      const clipId = new URL(item.url).pathname.split('/').pop();
      const iframe = document.createElement('iframe');
      iframe.width='100%'; iframe.height='100%'; iframe.allow='autoplay';
      iframe.src = `https://clips.twitch.tv/embed?clip=${encodeURIComponent(clipId)}&parent=${location.hostname}&autoplay=true&muted=false`;
      iframe.frameBorder='0';
      playerEl.appendChild(iframe);
    } else {
      playerEl.innerHTML='<div style="color:white;padding:20px;">지원되지 않는 영상입니다.</div>';
    }
  }

  playBtn.addEventListener('click', ()=>{
    if(queue.length===0) return;
    readyToPlay=true;
    mountPlayer(queue[currentIndex]);
    // 재생 후 자동 삭제
    const keyToRemove = queue[currentIndex].key;
    db.ref(`rooms/${ROOM}/queue/${keyToRemove}`).remove();
  });

</script>
</body>
</html>
