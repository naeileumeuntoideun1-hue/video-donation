<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Donation Overlay</title>
<style>
body, html{margin:0;padding:0;width:100%;height:100%;background:transparent;}
#player{position:absolute;inset:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
#message{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:3em;font-weight:bold;color:white;text-shadow:0 0 10px black;}
iframe, video{width:100%;height:100%;border:none;}
</style>
</head>
<body>
<div id="player"></div>
<div id="message" style="display:none;"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
  authDomain: "toiden.firebaseapp.com",
  databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toiden",
  storageBucket: "toiden.firebasestorage.app",
  messagingSenderId: "696461176231",
  appId: "1:696461176231:web:2120f172e52eaba91a1a82"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const player = document.getElementById('player');
const msgDiv = document.getElementById('message');

function escapeHtml(s){return (s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}

function playItem(item){
    // 메시지 먼저 보여주기
    msgDiv.textContent = escapeHtml(item.msg || item.name + " 님의 영상");
    msgDiv.style.display = 'flex';
    player.innerHTML='';

    setTimeout(()=>{
        msgDiv.style.display='none';
        player.innerHTML='';

        if(item.type==='youtube' && item.ytid){
            const iframe = document.createElement('iframe');
            iframe.src = `https://www.youtube.com/embed/${item.ytid}?autoplay=1&mute=0`;
            iframe.allow='autoplay; encrypted-media';
            player.appendChild(iframe);
        }else if(item.type==='twitch'){
            const iframe = document.createElement('iframe');
            iframe.src = `https://clips.twitch.tv/embed?clip=${encodeURIComponent(new URL(item.url).pathname.split('/').pop())}&parent=${location.hostname}&autoplay=true&muted=false`;
            iframe.allow='autoplay';
            player.appendChild(iframe);
        }else if(item.type==='html5'){
            const v = document.createElement('video');
            v.src = item.url; v.autoplay=true; v.controls=true; v.muted=false; v.playsInline=true;
            player.appendChild(v);
        }else{
            player.innerHTML='<div style="color:white;padding:20px;">지원되지 않는 영상</div>';
        }
    },5000);
}

// 실시간 overlay queue 구독
db.ref('rooms/tobrothertoiden/overlay').limitToFirst(1).on('child_added', snap=>{
    const item = snap.val();
    playItem(item);

    // 재생 후 자동 삭제
    setTimeout(()=>{ snap.ref.remove(); }, 10000); // 10초 후 삭제, 영상 길이에 맞게 조정 가능
});
</script>
</body>
</html>
