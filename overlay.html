<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>오버레이</title>
<style>
  body,html{margin:0;padding:0;background:transparent;overflow:hidden;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;}
  #player{width:80%;height:60%;display:flex;align-items:center;justify-content:center;margin-bottom:20px;}
  iframe,video{max-width:100%;max-height:100%;border:none;border-radius:8px;}
  #message{font-size:1.5rem;color:white;text-shadow:2px 2px 4px black;text-align:center;}
  #controls{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);}
  #playBtn{padding:10px 20px;font-size:1rem;border:none;border-radius:8px;background:#2563eb;color:white;cursor:pointer;}
  #playBtn:hover{background:#1e40af;}
</style>
</head>
<body>
<div id="player"></div>
<div id="message"></div>
<div id="controls">
  <button id="playBtn">영상 송출하기</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
const ROOM = 'tobrothertoiden';
const firebaseConfig = {
  apiKey: "AIzaSyBiDe-6X-nKUfAgwWWWriI2U9wpNpQ9hk8",
  authDomain: "toiden.firebaseapp.com",
  databaseURL: "https://toiden-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toiden",
  storageBucket: "toiden.firebasestorage.app",
  messagingSenderId: "696461176231",
  appId: "1:696461176231:web:2120f172e52eaba91a1a82"
};
firebase.initializeApp(firebaseConfig);

const dbRef = firebase.database().ref(`rooms/${ROOM}/queue`);
const $player = document.getElementById('player');
const $message = document.getElementById('message');
const $playBtn = document.getElementById('playBtn');

let queue = [];
let currentIndex = 0;
let isPlaying = false;

// 플레이어 마운트
function mountPlayer(item){
  $player.innerHTML='';
  $message.textContent = item.msg || '';
  if(!item) return;

  if(item.type==='youtube' && item.ytid){
    const iframe=document.createElement('iframe');
    iframe.src=`https://www.youtube.com/embed/${item.ytid}?autoplay=1&mute=1`;
    iframe.allow='autoplay; encrypted-media';
    iframe.width='100%'; iframe.height='100%';
    $player.appendChild(iframe);
  } else if(item.type==='twitch'){
    const iframe=document.createElement('iframe');
    const clipId = new URL(item.url).pathname.split('/').pop();
    iframe.src=`https://clips.twitch.tv/embed?clip=${encodeURIComponent(clipId)}&parent=${location.hostname}&autoplay=true&muted=true`;
    iframe.width='100%'; iframe.height='100%';
    $player.appendChild(iframe);
  } else if(item.type==='html5'){
    const v=document.createElement('video');
    v.src=item.url; v.autoplay=true; v.muted=true; v.controls=false; v.playsInline=true;
    v.width='100%'; v.height='100%';
    v.onended=playNext;
    $player.appendChild(v);
  }
}

// 다음 영상 재생
function playNext(){
  currentIndex++;
  if(currentIndex>=queue.length){currentIndex=0;} // 반복 재생
  mountPlayer(queue[currentIndex]);
}

// firebase 실시간 업데이트
dbRef.on('value', snap=>{
  const val = snap.val()||{};
  queue = Object.values(val);
  if(!isPlaying) return; // 송출 시작 전에는 화면 안 바뀜
});

// 송출 버튼 클릭 이벤트
$playBtn.addEventListener('click', ()=>{
  if(queue.length===0) return;
  isPlaying = true;
  mountPlayer(queue[currentIndex]);
});
</script>
</body>
</html>
